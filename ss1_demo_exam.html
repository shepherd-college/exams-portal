
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="fav_icon2.ico">
    <title>cbt.Shepherdinternationalcollege.org - DEMO    Exam</title>
    <script>
         // Disable back navigation
    history.pushState(null, null, location.href);
    window.onpopstate = function () {
        history.go(1);
    };

     let backClickCount = 0;
            let allowBack = false;

            history.pushState(null, null, location.href);

            window.onpopstate = function () {
                if (!allowBack) {
                    backClickCount++;

                    if (backClickCount >= 50) {
                        allowBack = true;
                        alert("You have tried 50 times. Going back now...");
                        history.back();
                        return;
                    }

                    showBackModal();
                }
            };

            function showBackModal() {
                document.getElementById("backModalOverlay").style.display = "flex";
                document.getElementById("passwordContainer").style.display = "none";
                document.getElementById("backPassword").value = "";
               
                document.getElementById("modalButtons").innerHTML = `
                    <button onclick="handleYes()" style="padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; background: limegreen; color: white; font-size: 16px; cursor: pointer;">Yes</button>
                    <button onclick="closeBackModal()" style="padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; background: crimson; color: white; font-size: 16px; cursor: pointer;">No</button>
                `;
            }

            function closeBackModal() {
                document.getElementById("backModalOverlay").style.display = "none";
                history.pushState(null, null, location.href);
            }

            function handleYes() {
                document.getElementById("passwordContainer").style.display = "block";
                document.getElementById("modalButtons").innerHTML = `
                    <button onclick="checkPassword()" style="padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; background: limegreen; color: white; font-size: 16px; cursor: pointer;">Submit</button>
                    <button onclick="closeBackModal()" style="padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; background: crimson; color: white; font-size: 16px; cursor: pointer;">Cancel</button>
                `;
            }

            function checkPassword() {
                const correctPassword = "admin123";
                const enteredPassword = document.getElementById("backPassword").value;

                if (enteredPassword === correctPassword) {
                    allowBack = true;
                    document.getElementById("backModalOverlay").style.display = "none";
                    history.back();
                } else {
                    alert("Incorrect password. Staying on this page.");
                    closeBackModal();
                }
            }
    </script>
</head>
         <div id="backModalOverlay" style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.8); color: #fff; font-family: Arial, sans-serif; justify-content: center; align-items: center; flex-direction: column;">
                <div id="backModal" style="background: #222; padding: 30px; border-radius: 10px; text-align: center; width: 90%; max-width: 400px;">
                    <p style="font-size: 18px; margin: 0 0 10px;">Do you really want to go back?</p>

                    <div id="passwordContainer" style="display: none;">
                        <p style="margin-top: 10px;">Enter password to go back:</p>
                        <input type="password" id="backPassword" placeholder="Enter password"
                            style="padding: 10px; width: 80%; margin-top: 10px; border-radius: 5px; border: none; font-size: 16px;">
                    </div>

                    <div id="modalButtons" style="margin-top: 20px;">
                        <button onclick="handleYes()" style="padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; background: limegreen; color: white; font-size: 16px; cursor: pointer;">Yes</button>
                        <button onclick="closeBackModal()" style="padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; background: crimson; color: white; font-size: 16px; cursor: pointer;">No</button>
                    </div>
                </div>
            </div>
                      

    <style>
        body {
            position: relative;
            z-index: 1;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f8f0;
        }
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('img/templogo1.jpg') no-repeat center center;
            background-size: 300px 300px;
            opacity: 0.1;
            z-index: 0;
            pointer-events: none;
        }
        #logout-container {
            text-align: right;
            padding: 10px;
            background: #2c3e50;
        }
        #datetime {
            color: gold;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }
        #logout {
            background-color: red;
            color: white;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            border-radius: 5px;
        }
        #header {
            padding: 20px;
            background: linear-gradient(to right, brown, darkred);
            color: white;
            border-bottom: 5px solid #ff9800;
        }
        #logo img {
            max-width: 200px;
            height: auto;
            display: block;
            margin: 0 auto;
        }
        #student-info {
            margin-top: 20px;
            text-align: center;
        }
        #student-image {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: block;
            margin: 0 auto 10px;
            border: 3px solid white;
            background: #ddd;
        }
        #welcome-message {
            color: #ffeb3b;
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        #userAnswerCount {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 8px;
            color: white;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            width: 200px;
            z-index: 100;
        }
        #answeredLabel {
            color: lime;
            font-size: 18px;
            font-weight: bold;
            margin: 5px 0;
        }
        #unansweredLabel {
            color: red;
            font-size: 18px;
            font-weight: bold;
            margin: 5px 0;
        }
        .container {
            margin: 20px auto;
            width: 80%;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        #questionText {
            width: 98%;
            min-height: 100px;
            resize: none;
            padding: 15px;
            font-size: 18px;
            color: #333;
            background-color: #f9f9f9;
            border-radius: 5px;
            border: 1px solid #ddd;
            margin-bottom: 15px;
            font-family: Arial, "Segoe UI Symbol", "Apple Symbols", sans-serif;
        }
        .option-group {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 12px;
            background-color: #f5f5f5;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .option-group:hover {
            background-color: #e8f5e8;
        }
        .option-group input {
            margin-right: 15px;
            transform: scale(1.3);
        }
        .option-group label {
            font-weight: bold;
            font-size: 16px;
            color: #333;
            font-family: Arial, "Segoe UI Symbol", "Apple Symbols", sans-serif;
        }
        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        .btn-cool {
            padding: 12px 25px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            background: #2e7d32;
            color: white;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: bold;
        }
        .btn-cool:hover {
            background: #1b5e20;
        }
        .questionButtons {
            margin: 15px 0;
            text-align: center;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
        }
        .question-btn {
            margin: 3px;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #444;
            cursor: pointer;
            font-weight: bold;
            background-color: #eee;
            min-width: 40px;
            transition: all 0.3s;
        }
        .question-btn:hover {
            background-color: #d0f0d0;
        }
        #timer {
            font-size: 24px;
            font-weight: bold;
            color: #e74c3c;
            text-align: center;
            margin: 10px 0;
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
            border: 2px solid #e74c3c;
        }
        .section-toggle {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }
        .section-btn {
            padding: 12px 24px;
            margin: 0 10px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .section-btn.active {
            background-color: #2e7d32;
            color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .section-btn:not(.active) {
            background-color: #e0e0e0;
            color: #333;
        }
        #theorySection {
            display: none;
            background: #fff9e6;
            color: #333;
            padding: 20px;
            border-radius: 8px;
            margin: 20px auto;
            width: 80%;
            border: 2px solid #ff9800;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        #theoryQuestionText {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 15px;
            line-height: 1.6;
            padding: 15px;
            background-color: #fff;
            border-radius: 5px;
            border-left: 5px solid #ff9800;
            font-family: Arial, sans-serif;
        }
        #theoryAnswer {
            width: 100%;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 16px;
            resize: vertical;
            min-height: 200px;
            font-family: Arial, sans-serif;
            margin-bottom: 15px;
        }
        .theory-nav-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .theory-btn {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        .theory-save-btn {
            background-color: #28a745;
            color: white;
        }
        .theory-save-btn:hover {
            background-color: #218838;
        }
        .theory-prev-btn, .theory-next-btn {
            background-color: #007bff;
            color: white;
        }
        .theory-prev-btn:hover, .theory-next-btn:hover {
            background-color: #0069d9;
        }
        .theory-submit-btn {
            background-color: #dc3545;
            color: white;
        }
        .theory-submit-btn:hover {
            background-color: #c82333;
        }
        .theory-status {
            text-align: center;
            margin: 10px 0;
            font-weight: bold;
            color: #333;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
        }
        .windows-activate {
            text-align: center;
            margin-top: 30px;
            color: #333;
            font-size: 14px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin: 20px;
        }
        .exam-info {
            text-align: center;
            font-weight: bold;
            margin: 10px 0;
            color: #2c3e50;
            font-size: 18px;
        }
        /* Math symbols styling */
        sup, sub {
            font-size: 0.75em;
            line-height: 1;
        }
        sup {
            vertical-align: super;
        }
        sub {
            vertical-align: sub;
        }
        /* Theory Question Images */
        .theory-image-container {
            margin: 15px 0;
            text-align: center;
        }
        .theory-image-wrapper {
            display: inline-block;
            max-width: 100%;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .theory-question-image {
            max-width: 100%;
            max-height: 300px;
            height: auto;
            border-radius: 5px;
            display: block;
            margin: 0 auto;
            background: #f0f0f0;
            padding: 10px;
        }
        .image-caption {
            font-style: italic;
            color: #666;
            margin-top: 8px;
            font-size: 14px;
            text-align: center;
        }
        /* Objective question images */
        #questionImageContainer {
            text-align: center;
            margin: 15px 0;
        }
        .question-image {
            max-width: 100%;
            max-height: 250px;
            height: auto;
            border-radius: 5px;
            border: 1px solid #ddd;
            padding: 5px;
            background: white;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body oncontextmenu="return false">
    <div id="header">
        <div id="logout-container">
            <button id="logout" onclick="logout()">Logout</button>
        </div>
        <div id="logo">
            <img src="img/templogo1.jpg" alt="COLLEGE CBT PORTAL">
        </div>
        <div id="student-info">
            <center><strong>ATTENTION! CLICK ON SUBMIT BUTTON BEFORE YOUR TIME IS UP TO SAVE YOUR SCORE</strong></center>
            <center><p id="datetime"></p></center>
              <div id="welcome-message">
            <label id="usernameDisplay"></label>
        </div>
         <div class="student-info">
          <img id="userImage" src="img/default_user.jpg" alt="Student Image" style="width:120px; height:120px; border-radius:50%; border:3px solid #008000; display:block; margin:0 auto;">
      
          <h2 id="username">Student Name</h2>
           </div>

        <!--<img id="userImage" src="img/default_user.jpg" alt="Student Image" style="width:120px; height:120px; border-radius:50%; border:3px solid #008000; display:block; margin:0 auto;">
      
            <center><img id="userImage"><br><br></center>
             <img id="userImage" src="img/default_user.jpg" alt="Student Image">
            <center>Hello: <span id="userName"></span></center>
        </div>-->

    
        <center><h3>SHEPHERD INTERNATIONAL COLLEGE SIJE  ADO EKITI </h3></center> 
        <center><h3>FIRST TERM EXAMINATION 2025/2026 ACADEMIC SESSION</h3></center>
       
        <!-- SECTION TOGGLE BUTTONS -->
        <div class="section-toggle">
            <button id="objectivesBtn" class="section-btn active" onclick="showSection('objectives')">OBJECTIVE QUESTIONS</button>
            <button id="theoryBtn" class="section-btn" onclick="showSection('theory')">THEORY QUESTIONS</button>
        </div>
       
        <div class="exam-info">
            Exam: <span id="examInfo" style="color: lime;">   DEMO    - SS1 (FIRST TERM)</span>
        </div>
       
        <div id="timer"></div>
    </div>
   
    <!-- OBJECTIVES SECTION -->
    <div id="objectivesSection">
        <div class="container">
            <h5 style="color: #d35400; text-align: center;">INSTRUCTIONS: READ THE QUESTIONS CAREFULLY BEFORE YOU CHOOSE YOUR ANSWER</h5>
            <div class="scroll-container">
                <div id="questionText"></div>
            </div>
           
            <div id="questionImageContainer"></div>
           
            <div class="option-group">
                <label class="option"><strong>A.</strong><input type="radio" name="option" value="A"> <span id="optA"></span></label>
            </div>
            <div class="option-group">
                <label class="option"><strong>B.</strong><input type="radio" name="option" value="B"> <span id="optB"></span></label>
            </div>
            <div class="option-group">
                <label class="option"><strong>C.</strong><input type="radio" name="option" value="C"> <span id="optC"></span></label>
            </div>
            <div class="option-group">
                <label class="option"><strong>D.</strong><input type="radio" name="option" value="D"> <span id="optD"></span></label>
            </div>
        </div>
       
        <div class="nav-buttons">
            <button onclick="prevQuestion()" class="btn-cool">Previous</button>
            <button onclick="nextQuestion()" class="btn-cool">Next</button>
            <button onclick="submitExam()" class="btn-cool">Submit Objectives</button>
        </div>
       
        <!-- Question navigation buttons -->
        <div class="container">
            <div id="questionButtons" class="questionButtons"></div>
        </div>
    </div>
   
    <!-- THEORY SECTION -->
    <div id="theorySection">
        <h3 style="text-align: center; color: #d35400; margin-bottom: 20px;">THEORY QUESTIONS SECTION</h3>
        <div class="theory-status" id="theoryStatus">
            Question 1 of 5 | Saved: 0/5
        </div>
        <div id="theoryQuestionContainer">
            <p id="theoryQuestionText">Loading theory questions...</p>
            <div id="theoryImageContainer"></div>
            <textarea id="theoryAnswer" rows="8" placeholder="Write your detailed answer here..."></textarea>
            <div class="theory-nav-buttons">
                <button onclick="prevTheoryQuestion()" class="theory-btn theory-prev-btn">Previous</button>
                <button onclick="saveTheoryAnswer()" class="theory-btn theory-save-btn">Save Answer</button>
                <button onclick="nextTheoryQuestion()" class="theory-btn theory-next-btn">Next</button>
                <button onclick="submitTheoryExam()" class="theory-btn theory-submit-btn">Submit Theory</button>
            </div>
        </div>
    </div>
   
    <div id="userAnswerCount">
        <p id="answeredLabel">Answered: 0/5</p>
        <p id="unansweredLabel">Unanswered: 5/5</p>
    </div>
   
    <div class="windows-activate">
        <p> &copy; cbt.Shepherdinternationalcollege.org</p>
    </div>

    <script>
           // Get stored username and image from sessionStorage
       
            
        // ================== STATIC QUESTIONS DATA ==================
        const staticObjectivesQuestions = [
            {
                id: 1,
                question: "What is the value of &pi; (pi) approximately?",
                options: {
                    A: "3.14",
                    B: "2.71",
                    C: "1.41",
                    D: "1.61"
                },
                answer: "A",
                image: "img/wfs101.png"
            },
            {
                id: 2,
                question: "If &theta; = 30&deg;, what is sin(&theta;)?",
                options: {
                    A: "1/2",
                    B: "&radic;3/2",
                    C: "&radic;2/2",
                    D: "1"
                },
                answer: "A",
                image: null
            },
            {
                id: 3,
                question: "What is the area of a circle with radius r?",
                options: {
                    A: "&pi;r^2",
                    B: "2&pi;r",
                    C: "&pi;r",
                    D: "4&pi;r^2"
                },
                answer: "A",
                image: null
            },
            {
                id: 4,
                question: "Solve for x: 2x + 5 = 15",
                options: {
                    A: "5",
                    B: "10",
                    C: "7.5",
                    D: "2.5"
                },
                answer: "A",
                image: null
            },
            {
                id: 5,
                question: "What is the Pythagorean theorem for a right-angled triangle?",
                options: {
                    A: "a^2 + b^2 = c^2",
                    B: "a + b = c",
                    C: "a &times; b = c",
                    D: "a^2 &times; b^2 = c^2"
                },
                answer: "A",
                image: null
            }
        
        ];

        const staticTheoryQuestions = [
            {
                id: 1,
                question: "Explain the concept of place value in Mathematics . Use examples to illustrate your explanation.",
                marks: 10,
                image: null
            },
            {
                id: 2,
                question: "What are prime numbers? Give five examples and explain why each is a prime number.",
                marks: 15,
                image: "img/SIC.png"
            },
            {
                id: 3,
                question: "Solve the equation: 3x + 7 = 22. Show all your working step by step.",
                marks: 12,
                image: null
            },
            {
                id: 4,
                question: "Calculate the perimeter of a rectangle with length 15cm and width 8cm. Explain your method and show all calculations.",
                marks: 10,
                image: null
            },
            {
                id: 5,
                question: "A triangle has angles measuring 45&deg;, 45&deg;, and 90&deg;. If the two equal sides are each 10cm long, calculate the length of the hypotenuse. Show your working using the Pythagorean theorem.",
                marks: 15,
                image: null
            }
        ];
        // ================== APPLICATION VARIABLES ==================
        let questions = [];
        let currentQuestion = 0;
        let userAnswers = [];
        let theoryQuestions = [];
        let currentTheory = 0;
        let theoryAnswers = [];
        let currentSection = 'objectives';
       
        // ================== INITIALIZATION ==================
        window.onload = function () {
            // Extract exam info from the page
            const examInfoElement = document.getElementById('examInfo');
            if (examInfoElement) {
                const examInfoText = examInfoElement.textContent;
                // Parse the text to extract subject and class
                // This is a simple example - adjust based on your actual text format
                localStorage.setItem('examSubject', 'FINAL TEST');
                localStorage.setItem('examClass', 'SCORE');
            }
            localStorage.setItem('examTerm', 'FIRST TERM 2025/2026');
             /*let username = sessionStorage.getItem('username');
             const userImage = sessionStorage.getItem('image');
            document.getElementById("usernameDisplay").innerText = "WELCOME:" + " " + username;
            document.getElementById('userImage').src = "img/student.png";
            document.getElementById('userName').innerText = username;
            document.getElementById('userImage').src = userImage;


            const username = sessionStorage.getItem('username') || 'Student';
            const userImageFile = sessionStorage.getItem('image');
            const userImagePath = userImageFile ? `img/${userImageFile}` : 'img/default_user.jpg';

            // Set username
            const usernameElements = [document.getElementById('userName'), document.getElementById('usernameDisplay')];
            usernameElements.forEach(el => { if(el) el.innerText = username; });

            // Set user image
            const userImageElement = document.getElementById('userImage');
            if(userImageElement){
                userImageElement.src = userImagePath;
                userImageElement.onerror = function(){
                    this.src = 'img/default_user.jpg'; // fallback if image not found
                };
            }*/
             const username = sessionStorage.getItem('username');
                const image = sessionStorage.getItem('image');

                if (!username) {
                  window.location.href = 'index.html';
                } else {
                  document.getElementById('username').innerText = username;
                  
              
                document.getElementById('userImage').src =
              'img/' + (sessionStorage.getItem('image') || 'default_user.jpg');
                }
           
            // Load static questions
            questions = staticObjectivesQuestions;
            theoryQuestions = staticTheoryQuestions;
           
            userAnswers = new Array(questions.length);
            theoryAnswers = new Array(theoryQuestions.length).fill('');
           
            updateDateTime();
            setInterval(updateDateTime, 1000);
           
            displayQuestion();
            renderQuestionButtons();
            countUserSelections();
            updateTheoryStatus();
        };
       
        // ================== TIMER ==================
        let timeLeft = 60 * 60; // 60 minutes
        const timerEl = document.getElementById('timer');
        const timerInterval = setInterval(() => {
            let min = Math.floor(timeLeft / 60);
            let sec = timeLeft % 60;
            timerEl.textContent = `Time Remaining: ${min}:${sec < 10 ? '0' + sec : sec}`;
            timeLeft--;
           
            // Change color when time is running out
            if (timeLeft < 300) { // 5 minutes
                timerEl.style.color = 'red';
                timerEl.style.animation = 'pulse 1s infinite';
            }
           
            if (timeLeft < 0) {
                clearInterval(timerInterval);
                alert("Time is up! Your exam will be submitted automatically.");
                submitExam();
            }
        }, 1000);
       
        // ================== SECTION TOGGLE ==================
        function showSection(section) {
            currentSection = section;
            // Update button states
            document.getElementById('objectivesBtn').classList.toggle('active', section === 'objectives');
            document.getElementById('theoryBtn').classList.toggle('active', section === 'theory');
           
            // Show/hide sections
            document.getElementById('objectivesSection').style.display = section === 'objectives' ? 'block' : 'none';
            document.getElementById('theorySection').style.display = section === 'theory' ? 'block' : 'none';
           
            // Update navigation
            if (section === 'theory') {
                displayTheoryQuestion();
            }
        }
       
        // ================== MATH SYMBOL MAPPING ==================
        function mapMathSymbol(text) {
            if (!text) return '';
           
            return text
                .replace(/&theta;/g, 'θ')
                .replace(/&Theta;/g, 'Θ')
                .replace(/&pi;/g, 'π')
                .replace(/&Pi;/g, 'Π')
                .replace(/&alpha;/g, 'α')
                .replace(/&beta;/g, 'β')
                .replace(/&gamma;/g, 'γ')
                .replace(/&delta;/g, 'δ')
                .replace(/&epsilon;/g, 'ε')
                .replace(/&phi;/g, 'φ')
                .replace(/&omega;/g, 'ω')
                .replace(/&mu;/g, 'μ')
                .replace(/&sigma;/g, 'σ')
                .replace(/&lambda;/g, 'λ')
                .replace(/&radic;/g, '√')
                .replace(/&infin;/g, '∞')
                .replace(/&int;/g, '∫')
                .replace(/&sum;/g, '∑')
                .replace(/&prod;/g, '∏')
                .replace(/&part;/g, '∂')
                .replace(/&deg;/g, '°')
                .replace(/&times;/g, '×')
                .replace(/&divide;/g, '÷')
                .replace(/&plusmn;/g, '±')
                .replace(/&le;/g, '≤')
                .replace(/&ge;/g, '≥')
                .replace(/&ne;/g, '≠')
                .replace(/&frac12;/g, '½')
                .replace(/&frac14;/g, '¼')
                .replace(/&frac34;/g, '¾')
                .replace(/\^(\d+)/g, '<sup>$1</sup>')
                .replace(/\^\(([^)]+)\)/g, '<sup>$1</sup>')
                .replace(/_(\d+)/g, '<sub>$1</sub>')
                .replace(/_\(([^)]+)\)/g, '<sub>$1</sub>');
        }
       
        // ================== OBJECTIVES FUNCTIONS ==================
        function saveAnswer() {
            const selected = document.querySelector('input[name="option"]:checked');
            if (selected) {
                userAnswers[currentQuestion] = selected.value;
                countUserSelections();
            }
        }
       
        function displayQuestion() {
            if (currentQuestion >= questions.length) return;
           
            const q = questions[currentQuestion];
           
            // Apply math symbol mapping
            const questionText = mapMathSymbol(q.question);
            const optA = mapMathSymbol(q.options.A);
            const optB = mapMathSymbol(q.options.B);
            const optC = mapMathSymbol(q.options.C);
            const optD = mapMathSymbol(q.options.D);
           
            // Display question and options
            document.getElementById('questionText').innerHTML = `${currentQuestion + 1}. ${questionText}`;
            document.getElementById('optA').innerHTML = optA;
            document.getElementById('optB').innerHTML = optB;
            document.getElementById('optC').innerHTML = optC;
            document.getElementById('optD').innerHTML = optD;
           
            // Handle question image
            const imageContainer = document.getElementById('questionImageContainer');
            if (q.image) {
                imageContainer.innerHTML = `
                    <div class="theory-image-wrapper">
                        <img src="${q.image}" alt="Question Diagram" class="question-image">
                    </div>
                `;
            } else {
                imageContainer.innerHTML = '';
            }
           
            // Clear and set radio buttons
            const radios = document.getElementsByName('option');
            radios.forEach(r => r.checked = false);
           
            if (userAnswers[currentQuestion]) {
                document.querySelector(`input[name="option"][value="${userAnswers[currentQuestion]}"]`).checked = true;
            }
           
            highlightCurrentButton();
        }
       
        function nextQuestion() {
            saveAnswer();
            if (currentQuestion < questions.length - 1) {
                currentQuestion++;
                displayQuestion();
            }
        }
       
        function prevQuestion() {
            saveAnswer();
            if (currentQuestion > 0) {
                currentQuestion--;
                displayQuestion();
            }
        }
       
        function renderQuestionButtons() {
            const container = document.getElementById('questionButtons');
            container.innerHTML = '';
           
            for (let i = 0; i < questions.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'question-btn';
                btn.onclick = () => {
                    saveAnswer();
                    currentQuestion = i;
                    displayQuestion();
                };
                container.appendChild(btn);
            }
            highlightCurrentButton();
        }
       
        function highlightCurrentButton() {
            document.querySelectorAll('.question-btn').forEach((btn, index) => {
                const answered = userAnswers[index] !== undefined;
                const current = index === currentQuestion;
               
                btn.style.backgroundColor = current ? '#5cb85c' : (answered ? '#337ab7' : '#eee');
                btn.style.color = current || answered ? 'white' : 'black';
                btn.style.border = current ? '2px solid #2e7d32' : '1px solid #444';
            });
        }
       
        function countUserSelections() {
            let totalQuestions = questions.length;
            let answeredCount = userAnswers.filter(answer => answer !== undefined).length;
            let unansweredCount = totalQuestions - answeredCount;
           
            document.getElementById("answeredLabel").innerText = `Answered: ${answeredCount}/${totalQuestions}`;
            document.getElementById("unansweredLabel").innerText = `Unanswered: ${unansweredCount}`;
        }
       
        /*function submitExam() {
            saveAnswer();
            let score = 0;
            questions.forEach((q, i) => {
                if (userAnswers[i] === q.answer) score++;
            });
           
            clearInterval(timerInterval);
            alert(`Objective Exam Completed!\nYour Score: ${score} out of ${questions.length}`);
        }*/
         function submitExam() {
            saveAnswer();
            showResult();
        }
       
        /*function showResult() {
            clearInterval(timerInterval);
            let score = 0;
            questions.forEach((q, i) => {
                if (userAnswers[i] === q.answer) score++;
            });
           
            const username = localStorage.getItem("username") || "Guest";
            localStorage.setItem("examUser", username);
            localStorage.setItem("examScore", score);
            localStorage.setItem("totalQuestions", questions.length);


            // Save exam data before going to result page
            localStorage.setItem("student_name", username);
            localStorage.setItem("student_class", selectedClass);
            localStorage.setItem("exam_subject", selectedSubject);
            localStorage.setItem("student_image", studentImageURL);
            localStorage.setItem("exam_score", score);
            localStorage.setItem("total_questions", totalQuestions);

                // Redirect to results page
                window.location.href = "results.html";
           
            alert(`Objective Exam Completed!\nYour Score: ${score} out of ${questions.length}`);
            window.location.href = "results.html";
        }*/
        /*function showResult() {
            clearInterval(timerInterval);
            let score = 0;
            questions.forEach((q, i) => {
                if (userAnswers[i] === q.answer) score++;
            });
           
            const username = localStorage.getItem("username") || "Guest";
            const cls = sessionStorage.getItem("class");
            const sub = sessionStorage.getItem("subject");
           
            localStorage.setItem("examUser", username);
            localStorage.setItem("examScore", score);
            localStorage.setItem("totalQuestions", questions.length);
            localStorage.setItem("examInfo", document.getElementById('examInfo').textContent.trim());
           
            // ✅ Mark exam as completed
            if (cls && sub) {
                const attempts = getExamAttempts(cls);
                if (!attempts[username]) {
                    attempts[username] = {};
                }
                attempts[username][sub] = true;
                saveExamAttempts(cls, attempts);
            }
           
            alert(`Objective Exam Completed!\nYour Score: ${score} out of ${questions.length}`);
            window.location.href = "results.html";
    }*/
       function showResult() {
                    clearInterval(timerInterval);
                    let score = 0;
                    questions.forEach((q, i) => {
                        if (userAnswers[i] === q.answer) score++;
                    });
                   
                    const username = sessionStorage.getItem('username') || "Guest";
                    const cls = sessionStorage.getItem('class');
                    const sub = sessionStorage.getItem('subject');
                   
                    localStorage.setItem("examUser", username);
                    localStorage.setItem("examScore", score);
                    localStorage.setItem("totalQuestions", questions.length);
                    localStorage.setItem("pendingClass", cls);
                    localStorage.setItem("pendingSubject", sub);
                    localStorage.setItem("pendingUsername", username);
                   
                    // ✅ Get exam info from sessionStorage or use default
                    const examInfo = sessionStorage.getItem('examInfo') || 'EXAMINATION - RERSULT (FIRST TERM)';
                    localStorage.setItem("examInfo", examInfo);
                   
                    // ✅ DO NOT mark exam as completed here - wait for confirmation on results page
                    console.log(`Exam completed but not marked as attempted yet. Waiting for confirmation.`);
                   
                    alert(`Objective Exam Completed!\nYour Score: ${score} out of ${questions.length}\n\nClick OK to view your results and confirm your attempt.`);
                    window.location.href = "results.html";
        }

            // Add these helper functions to your exam page
            function getExamAttempts(cls) {
                const key = `${cls}_exam_attempts`;
                const stored = localStorage.getItem(key);
                return stored ? JSON.parse(stored) : {};
            }

            function saveExamAttempts(cls, data) {
                const key = `${cls}_exam_attempts`;
                localStorage.setItem(key, JSON.stringify(data));
            }
                   
        // ================== THEORY QUESTIONS ==================
        function displayTheoryQuestion() {
            if (theoryQuestions.length === 0) {
                document.getElementById('theoryQuestionText').innerText = "No theory questions available.";
                return;
            }
           
            const tq = theoryQuestions[currentTheory];
           
            // Display question text (without math symbol mapping for theory)
            document.getElementById('theoryQuestionText').innerText = mapMathSymbol(`${currentTheory + 1}. ${tq.question} ${tq.marks ? `[${tq.marks} marks]` : ''}`);
                
            document.getElementById('theoryAnswer').value = theoryAnswers[currentTheory] || "";
           
            // Handle theory question image
            const theoryImageContainer = document.getElementById('theoryImageContainer');
            if (tq.image) {
                theoryImageContainer.innerHTML = `
                    <div class="theory-image-wrapper">
                        <img src="${tq.image}" alt="Theory Question Diagram" class="theory-question-image">
                        <div class="image-caption">${tq.imageCaption || 'Diagram for question'}</div>
                    </div>
                `;
            } else {
                theoryImageContainer.innerHTML = '';
            }
           
            updateTheoryStatus();
        }
       
        function updateTheoryStatus() {
            const savedCount = theoryAnswers.filter(answer => answer.trim() !== "").length;
            document.getElementById("theoryStatus").innerText =
                `Question ${currentTheory + 1} of ${theoryQuestions.length} | Saved: ${savedCount}/${theoryQuestions.length}`;
        }
       
        function saveTheoryAnswer() {
            const answer = document.getElementById('theoryAnswer').value.trim();
            theoryAnswers[currentTheory] = answer;
            localStorage.setItem(`theoryAnswer_${currentTheory}`, answer);
            updateTheoryStatus();
            alert("Theory answer saved successfully!");
        }
       
        function nextTheoryQuestion() {
            if (currentTheory < theoryQuestions.length - 1) {
                currentTheory++;
                displayTheoryQuestion();
            } else {
                alert("You've reached the last theory question.");
            }
        }
       
        function prevTheoryQuestion() {
            if (currentTheory > 0) {
                currentTheory--;
                displayTheoryQuestion();
            }
        }
       
        function submitTheoryExam() {
            const savedCount = theoryAnswers.filter(answer => answer.trim() !== "").length;
            const confirmSubmit = confirm(
                `Theory section completed!\n\n` +
                `You have answered ${savedCount} out of ${theoryQuestions.length} theory questions.\n\n` +
                `Are you sure you want to submit?`
            );
           
            if (confirmSubmit) {
                alert("Theory answers submitted successfully!");
            }
        }
       
        // ================== DATE & TIME ==================
        function updateDateTime() {
            let now = new Date();
            let day = now.getDate();
            let month = now.toLocaleString('default', { month: 'long' });
            let year = now.getFullYear();
            let suffix = "th";
           
            if (day === 1 || day === 21 || day === 31) suffix = "st";
            else if (day === 2 || day === 22) suffix = "nd";
            else if (day === 3 || day === 23) suffix = "rd";
           
            let hours = now.getHours();
            let minutes = now.getMinutes();
            let seconds = now.getSeconds();
            let ampm = hours >= 12 ? "PM" : "AM";
            hours = hours % 12 || 12;
            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;
           
            let formattedDateTime = `${month} ${day}${suffix} ${year}, ${hours}:${minutes}:${seconds} ${ampm}`;
            document.getElementById("datetime").innerText = formattedDateTime;
        }
       
        // ================== KEYBOARD SHORTCUTS ==================
        document.addEventListener('keydown', function (event) {
            if (currentSection === 'objectives') {
                const key = event.key.toUpperCase();
               
                // Answer selection for objectives
                if (['A', 'B', 'C', 'D'].includes(key)) {
                    const radio = document.querySelector(`input[name="option"][value="${key}"]`);
                    if (radio) {
                        radio.checked = true;
                        saveAnswer();
                    }
                }
               
                // Navigation with arrows
                if (event.key === 'ArrowRight') {
                    nextQuestion();
                } else if (event.key === 'ArrowLeft') {
                    prevQuestion();
                }
            } else if (currentSection === 'theory') {
                // Navigation for theory
                if (event.key === 'ArrowRight') {
                    nextTheoryQuestion();
                } else if (event.key === 'ArrowLeft') {
                    prevTheoryQuestion();
                }
               
                // Save with Ctrl+S
                if (event.ctrlKey && event.key === 's') {
                    event.preventDefault();
                    saveTheoryAnswer();
                }
            }
        });
       
        // ================== ANTI-CHEAT & LOGOUT ==================
        document.addEventListener('keydown', function (event) {
            const key = event.key.toLowerCase();
            if ((event.ctrlKey && (key === 'p' || key === 's')) && currentSection === 'objectives') {
                event.preventDefault();
                alert("Right-click and view source are disabled during examination.");
                return false;
            }
        });
       
        document.addEventListener('contextmenu', (event) => {
            event.preventDefault();
            alert("Right-click is disabled during examination.");
        });
       
        document.addEventListener('keydown', function (e) {
            if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I') ||
                (e.ctrlKey && e.shiftKey && e.key === 'J') || (e.ctrlKey && e.key === 'u')) {
                e.preventDefault();
                alert("Developer tools are disabled during examination.");
            }
        });
       
        function logout() {
            const confirmLogout = confirm("Are you sure you want to logout? Your progress may be lost.");
            if (confirmLogout) {
                window.location.href = "index.html";
            }
        }
    </script>
</body>
</html>
